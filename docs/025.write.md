# Write diary

## Server: Koa.js

### Database

#### Create a article model

```bash
yarn sequelize model:generate \
--name Article \
--attributes \
title:string,content:text
```

New model was created.  
New migration was created.

#### Add a association

```bash
yarn sequelize migration:generate \
--name add-association-article-user
```

New migration was created.

##### migration: add-association-article-user

```js
'use strict'

module.exports = {
  up: (queryInterface, Sequelize) => {
    return queryInterface.addColumn('Articles', 'UserId', {
      type: Sequelize.INTEGER,
      references: {
        model: 'Users',
        key: 'id',
      },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL',
    })
  },

  down: (queryInterface, Sequelize) => {
    return queryInterface.removeColumn('Articles', 'UserId')
  },
}
```

##### model: user

```js
'use strict'
module.exports = (sequelize, DataTypes) => {
  const User = sequelize.define(
    'User',
    {
      name: DataTypes.STRING,
    },
    {}
  )
  User.associate = function(models) {
    User.hasOne(models.Oauth)
    User.hasMany(models.Article)
  }
  return User
}
```

#### Create a table in the database

```bash
yarn sequelize db:migrate
```

#### Seed articles

##### Create a seed file

```bash
yarn sequelize seed:generate \
--name demo-article
```

New seed was created.

##### Add seed data

```js
'use strict'

module.exports = {
  up: (queryInterface, Sequelize) => {
    return queryInterface.bulkInsert(
      'Articles',
      [
        {
          title: 'Beautiful Amsterdam',
          content:
            'Simon Bishop had always loved beautiful Amsterdam with its magnificent, motionless mountains. It was a place where he felt sleepy.',
          UserId: 1,
          createdAt: new Date(),
          updatedAt: new Date(),
        },
        {
          title: 'Violent Kate Hemingway',
          content:
            'Kate Hemingway had always loved snooty San Diego with its healthy, heavy hills. It was a place where she felt unstable.',
          UserId: 2,
          createdAt: new Date(),
          updatedAt: new Date(),
        },
      ],
      {}
    )
  },

  down: (queryInterface, Sequelize) => {
    return queryInterface.bulkDelete('Articles', null, {})
  },
}
```

##### Insert seed data

```bash
yarn sequelize db:migrate:undo:all
yarn sequelize db:migrate
yarn sequelize db:seed:all
```

### API

#### model

```bash
vi src/models/article.ts
```

```ts
import models from '../db/models'

interface User {
  id: number
  name: string
}

interface Article {
  id: number
  title: string
  content: string
  createdAt: Date
  updatedAt: Date
  User: User
}

export const loadArticles = async (
  page: number = 1,
  size: number = 10
): Promise<Article[]> => {
  try {
    const articles = await models.Article.findAll({
      attributes: ['id', 'title', 'content', 'createdAt', 'updatedAt'],
      offset: page - 1,
      limit: size,
      order: [['createdAt', 'DESC']],
      include: [
        {
          model: models.User,
          attributes: ['id', 'name'],
        },
      ],
    })
    return articles
  } catch (error) {
    console.error(error)
  }
  return null
}

export const saveArticle = async (
  UserId: number,
  title: string,
  content: string
): Promise<void> => {
  try {
    await models.Article.create({
      title: title,
      content: content,
      createdAt: new Date(),
      updatedAt: new Date(),
      UserId: UserId,
    })
  } catch (error) {
    console.error(error)
  }
}

export const deleteArticle = async (id: number): Promise<void> => {
  try {
    await models.Article.destroy({
      where: {
        id: id,
      },
    })
  } catch (error) {
    console.error(error)
  }
}
```

#### routes

```bash
vi src/routes/article.ts
```

```ts
import { DefaultState, Context } from 'koa'
import Router from '@koa/router'
import { loadArticles, saveArticle, deleteArticle } from '../models/article'

const router = new Router<DefaultState, Context>({
  prefix: '/article',
})

router.get('/list', async (ctx, next) => {
  const articles = await loadArticles(1, 10)
  ctx.body = {
    success: true,
    message: 'Article list',
    data: articles,
  }
})

interface Submit {
  UserId: number
  title: string
  content: string
}

router.post('/submit', async (ctx, next) => {
  const data: Submit = ctx.request.body
  await saveArticle(data.UserId, data.title, data.content)
  ctx.body = {
    success: true,
    message: 'Submit article',
    data: null,
  }
})

interface Delete {
  id: number
}

router.post('/delete', async (ctx, next) => {
  const data: Delete = ctx.request.body
  await deleteArticle(data.id)
  ctx.body = {
    success: true,
    message: 'Delete article',
    data: null,
  }
})

export default router
```

```bash
vi src/routes/api.ts
```

```ts
import article from './article'

router.use(article.routes(), article.allowedMethods())
```

---

## Client: React.js

### react-helmet

[nfl/react-helmet](https://github.com/nfl/react-helmet)

```bash
yarn add react-helmet
```

### Component

```bash

```

```tsx
```

### Page

```bash

```

```tsx
```

---
